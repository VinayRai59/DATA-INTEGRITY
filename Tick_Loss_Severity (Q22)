#include <ixwebsocket/IXWebSocket.h>
#include <iostream>
#include <unistd.h>
#include <string>
#include <nlohmann/json.hpp>

using namespace std;
using json=nlohmann::json;

int main(){
    ix::WebSocket ws;

    bool has_last=false;
    long long last_id=-1;

    ws.setUrl("wss://stream.binance.com:9443/ws/btcusdt@trade");

    ws.setOnMessageCallback(
        [&] (const ix::WebSocketMessagePtr& msg)
        {
            if(msg->type==ix::WebSocketMessageType::Open)
            {
                cout<<"Websocket Connected Successfully"<<endl;
                has_last=false;
                last_id=-1;
            }

            else if(msg->type==ix::WebSocketMessageType::Message)
            {
                try
                {
                    json j=json::parse(msg->str);

                    if(j.contains("result") && j.contains("id"))
                    {
                        return;
                    }

                    if(j.contains("e") && j["e"]=="trade")
                    {
                        long long trade_id=j["t"].get<long long>();

                        if(!has_last)
                        {
                            has_last=true;
                            last_id=trade_id;
                        }

                        else if(trade_id<=last_id)
                        {
                            cout<<"Out of order"<<trade_id<<endl;
                        }

                        else if(trade_id==last_id+1)
                        {
                            cout<<"Normal : "<<trade_id<<endl;
                            last_id=trade_id;
                        }

                        else if(trade_id>last_id+1)
                        {
                            long long missing=trade_id-last_id-1;
                            if(missing<=2)
                            {
                                cout<<"Normal Market Burst"<<endl;
                                //Stragy safe
                                //Log only
                            }

                            else if(missing>=3 && missing<=20)
                            {
                                cout<<"Candle impact possible"<<endl;
                                //REST backfill trigger
                                //Strategy continue
                            }

                            else{
                                cout<<"Data Unreliable"<<endl;
                                //Strategy pause
                                //Full recovery/alert
                            }

                            last_id=trade_id;
                        }
                    }
                }
                catch(exception& e)
                {
                    cout<<"Error : "<<e.what()<<endl;
                }
                
            }

            else if(msg->type==ix::WebSocketMessageType::Error)
            {
                cout<<"Error : "<<msg->errorInfo.reason<<endl;
            }

            else if(msg->type==ix::WebSocketMessageType::Close)
            {
                cout<<"Websocket Closed Successfully with "<<msg->closeInfo.reason<<endl;
            }
        }
    );

    ws.start();

    while(true)
    {
        usleep(500);
    }

    ws.stop();

    return 0;
}
